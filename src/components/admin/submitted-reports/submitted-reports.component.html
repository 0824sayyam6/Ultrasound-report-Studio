<style>
  @media print {
    @page {
      size: A4;
      margin: 20mm;
    }
    body * {
      visibility: hidden;
    }
    .print-only, .print-only * {
      visibility: visible;
    }
    .print-only {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
    .page-break {
      page-break-after: always;
      break-after: page;
    }
     .report-paper {
      box-shadow: none !important;
      border: none !important;
    }
  }
</style>

<!-- Main UI (hidden during print) -->
<div class="no-print">
  <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg relative">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6 border-b border-slate-200 pb-4 gap-4">
      <div>
        <h2 class="text-xl font-bold text-slate-800">Submitted Reports</h2>
        <p class="text-sm text-slate-500 mt-1">Browse and view all finalized ultrasound reports.</p>
      </div>
      <div class="flex items-center gap-2 w-full sm:w-auto">
        <div class="relative flex-grow">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <i class="fas fa-search text-slate-400"></i>
          </div>
          <input 
            type="text" 
            placeholder="Search by patient or exam..." 
            (input)="onSearch($event)"
            class="block w-full rounded-md border-slate-300 py-2 pl-10 pr-3 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
        </div>
         <button (click)="exportToPdf()" title="Export to PDF" class="inline-flex items-center justify-center px-3 py-2 border border-slate-300 text-sm font-medium rounded-md shadow-sm text-slate-700 bg-white hover:bg-slate-50">
          <i class="fas fa-file-pdf text-base"></i>
        </button>
      </div>
    </div>

    <!-- Status Message -->
    @if (statusMessage(); as msg) {
      <div class="absolute top-6 right-8 px-4 py-2 rounded-md shadow-lg text-center bg-green-100 text-green-800">
          <p class="text-sm font-medium">{{ msg.text }}</p>
      </div>
    }

    <!-- Report List -->
    <div class="space-y-3">
      @for (report of filteredReports(); track report.id) {
        <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md hover:border-blue-300 transition-all duration-200">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <div class="flex-1">
              <h3 class="font-semibold text-slate-800">{{ report.patient.name }} <span class="text-slate-500 font-normal">- {{ report.patient.patientId }}</span></h3>
              <p class="text-sm text-slate-600">{{ report.study.examType }}</p>
              <p class="text-xs text-slate-400 mt-1">Submitted: {{ report.lastSaved | date:'short' }}</p>
            </div>
            <div class="flex items-center space-x-2">
               <button (click)="viewReport(report.id)" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-eye mr-2"></i>
                View
              </button>
              <button 
                (click)="deleteReport(report)" 
                class="inline-flex items-center justify-center w-8 h-8 rounded-full text-red-600 hover:bg-red-100 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                title="Delete Report">
                <span class="sr-only">Delete report for {{ report.patient.name }}</span>
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        </div>
      } @empty {
        <div class="text-center py-12 border-2 border-dashed border-slate-200 rounded-lg">
          <i class="fas fa-file-excel text-4xl text-slate-400"></i>
          <p class="mt-4 text-slate-500">No submitted reports found.</p>
           @if (allReports().length > 0 && filteredReports().length === 0) {
            <p class="text-sm text-slate-400">Try adjusting your search term.</p>
          }
        </div>
      }
    </div>
  </div>
</div>

<!-- Print-only section for detailed PDF export -->
<div class="print-only">
  @for(report of filteredReports(); track report.id; let last = $last) {
    <div class="report-paper bg-white p-12" [class.page-break]="!last" style="width: 210mm; min-height: 297mm;">
      <!-- Report Header -->
      <header class="pb-6 mb-8 border-b-2 border-slate-300">
        <div class="flex justify-between items-start">
           <div class="flex items-center space-x-4">
            @if(clinic().logoUrl) {
              <img [src]="clinic().logoUrl" alt="Clinic Logo" class="max-h-16">
            }
            <div>
              <h2 class="text-2xl font-bold text-slate-800">Ultrasound Report</h2>
              <p class="text-sm text-slate-500">Confidential Medical Document</p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-semibold text-slate-700">{{ clinic().name }}</p>
            <p class="text-xs text-slate-500">{{ clinic().address }}</p>
            <p class="text-xs text-slate-500">{{ clinic().phone }}</p>
          </div>
        </div>
      </header>

      <!-- Patient & Study Details -->
      <section class="mb-8">
        <div class="grid grid-cols-2 gap-x-8 gap-y-2">
          <div><strong class="font-semibold text-slate-700 w-28 inline-block">Patient:</strong> {{ report.patient.name }}</div>
          <div><strong class="font-semibold text-slate-700 w-28 inline-block">Exam Type:</strong> {{ report.study.examType }}</div>
          <div><strong class="font-semibold text-slate-700 w-28 inline-block">Patient ID:</strong> {{ report.patient.patientId }}</div>
          <div><strong class="font-semibold text-slate-700 w-28 inline-block">Study Date:</strong> {{ report.study.studyDate }}</div>
          <div><strong class="font-semibold text-slate-700 w-28 inline-block">DOB:</strong> {{ report.patient.dob }}</div>
          <div><strong class="font-semibold text-slate-700 w-28 inline-block">Referring MD:</strong> {{ report.study.referringPhysician }}</div>
        </div>
      </section>

      <!-- Report Body -->
      <main class="text-slate-800 text-sm space-y-6">
        <section>
          <h3 class="font-bold text-base mb-2 border-b pb-1">FINDINGS</h3>
          <p class="whitespace-pre-wrap">{{ report.findings || 'No findings entered.' }}</p>
        </section>
        <section>
          <h3 class="font-bold text-base mb-2 border-b pb-1">IMPRESSION</h3>
          <p class="whitespace-pre-wrap">{{ report.impression || 'No impression entered.' }}</p>
        </section>
        <section>
          <h3 class="font-bold text-base mb-2 border-b pb-1">RECOMMENDATIONS</h3>
          <p class="whitespace-pre-wrap">{{ report.recommendations || 'No recommendations entered.' }}</p>
        </section>
      </main>

      <!-- Report Footer -->
      <footer class="pt-8 mt-auto text-center text-xs text-slate-400">
        <div class="border-t pt-4">
          <p>Electronically signed on {{ report.lastSaved | date:'short' }}</p>
          <p>Page 1 of 1</p>
        </div>
      </footer>
    </div>
  }
</div>
