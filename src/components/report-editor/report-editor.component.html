<div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg" [formGroup]="reportForm">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <!-- Left Column: Patient and Study Info -->
    <div class="space-y-6">
      <section formGroupName="patient">
        <h2 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4 flex items-center">
          <i class="fas fa-user mr-3 text-slate-500"></i>Patient Information
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-600">Full Name</label>
            <input type="text" formControlName="name" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600">Patient ID</label>
            <input type="text" formControlName="patientId" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600">Date of Birth</label>
            <input type="date" formControlName="dob" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600">Gender</label>
            <select formControlName="gender" class="mt-1 block w-full rounded-md bg-slate-300 border-transparent appearance-none shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
              <option>Female</option>
              <option>Male</option>
              <option>Other</option>
            </select>
          </div>
        </div>
      </section>

      <section formGroupName="study">
        <h2 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4 flex items-center">
          <i class="fas fa-file-medical mr-3 text-slate-500"></i>Study Information
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-slate-600">Exam Type</label>
            <input type="text" formControlName="examType" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900" placeholder="e.g., Abdominal Ultrasound">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600">Body Part</label>
            <input type="text" formControlName="bodyPart" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-600">Study Date</label>
            <input type="date" formControlName="studyDate" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
          </div>
           <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-slate-600">Referring Physician</label>
            <input type="text" formControlName="referringPhysician" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900">
          </div>
        </div>
      </section>
    </div>

    <!-- Right Column: Report Text Areas -->
    <div class="space-y-4">
      <section>
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-semibold text-slate-600">Findings</label>
          <button (click)="fetchSuggestions()" [disabled]="isLoadingSuggestions() || reportForm.disabled" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-slate-300 disabled:cursor-not-allowed">
            @if (isLoadingSuggestions()) {
              <i class="fas fa-spinner fa-spin -ml-1 mr-2 h-4 w-4"></i>
              <span>Generating...</span>
            } @else {
              <i class="fas fa-wand-magic-sparkles -ml-1 mr-2 h-4 w-4"></i>
              <span>Get AI Suggestion</span>
            }
          </button>
        </div>
        
        @if (error()) {
          <div class="bg-red-50 border-l-4 border-red-400 p-3 my-2 rounded-r-lg">
            <p class="text-sm text-red-700">{{ error() }}</p>
          </div>
        }
        
        @if (suggestion()) {
          <div class="bg-blue-50 border-l-4 border-blue-400 p-4 my-2 rounded-r-lg">
            <p class="text-sm text-slate-600 font-medium mb-2">AI Suggestion:</p>
            <div class="text-sm text-slate-800 whitespace-pre-wrap bg-white p-3 rounded-md border border-slate-200">{{ suggestion() }}</div>
            <div class="mt-3 flex justify-end">
              <button (click)="applySuggestion()" class="px-3 py-1.5 text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Apply Suggestion</button>
            </div>
          </div>
        }

        <textarea formControlName="findings" rows="10" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900"></textarea>
      </section>

       <section>
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-semibold text-slate-600">Impression</label>
          <button (click)="fetchImpressionSuggestions()" [disabled]="isLoadingImpressionSuggestions() || reportForm.disabled" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-slate-300 disabled:cursor-not-allowed">
            @if (isLoadingImpressionSuggestions()) {
              <i class="fas fa-spinner fa-spin -ml-1 mr-2 h-4 w-4"></i>
              <span>Generating...</span>
            } @else {
              <i class="fas fa-wand-magic-sparkles -ml-1 mr-2 h-4 w-4"></i>
              <span>Get AI Suggestion</span>
            }
          </button>
        </div>

        @if (impressionError()) {
          <div class="bg-red-50 border-l-4 border-red-400 p-3 my-2 rounded-r-lg">
            <p class="text-sm text-red-700">{{ impressionError() }}</p>
          </div>
        }
        
        @if (impressionSuggestion()) {
          <div class="bg-blue-50 border-l-4 border-blue-400 p-4 my-2 rounded-r-lg">
            <p class="text-sm text-slate-600 font-medium mb-2">AI Suggestion:</p>
            <div class="text-sm text-slate-800 whitespace-pre-wrap bg-white p-3 rounded-md border border-slate-200">{{ impressionSuggestion() }}</div>
            <div class="mt-3 flex justify-end">
              <button (click)="applyImpressionSuggestion()" class="px-3 py-1.5 text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Apply Suggestion</button>
            </div>
          </div>
        }

        <textarea formControlName="impression" rows="4" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900"></textarea>
      </section>

      <section>
        <label class="block text-sm font-semibold text-slate-600">Recommendations</label>
        <textarea formControlName="recommendations" rows="3" class="mt-1 block w-full rounded-md bg-slate-200 border-transparent shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-900"></textarea>
      </section>
    </div>
  </div>

  <!-- Action Bar and Status -->
  <div class="sticky bottom-[-32px] bg-white/90 backdrop-blur-sm border-t border-slate-200 py-3 px-8 -mx-8 -mb-8 mt-8 rounded-b-xl">
    <div class="relative flex items-center justify-between">
      <div class="flex-1">
        @if (reportService.reportState(); as report) {
          @if (report.status === 'submitted') {
            <span class="text-sm font-medium text-green-600 flex items-center">
              <i class="fas fa-check-circle mr-2"></i>Report Submitted Successfully
            </span>
          } @else if(report.lastSaved) {
            <span class="text-sm text-slate-500 italic">
              Last saved: {{ report.lastSaved | date:'mediumTime' }}
            </span>
          } @else {
            <span class="text-sm text-slate-500 italic">
              A new report is being drafted.
            </span>
          }
        }
      </div>
      <div class="flex items-center space-x-3">
        @if (reportService.reportState().status !== 'submitted') {
          <button (click)="onSaveDraft()" [disabled]="isSaving() || isSubmitting()" class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md shadow-sm text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 w-32">
            @if (isSaving()) {
              <i class="fas fa-spinner fa-spin"></i>
            } @else {
              <span>Save Draft</span>
            }
          </button>
          <button (click)="onSubmitReport()" [disabled]="isSaving() || isSubmitting() || reportForm.invalid" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed w-36">
            @if (isSubmitting()) {
              <i class="fas fa-spinner fa-spin"></i>
            } @else {
              <span>Submit Report</span>
            }
          </button>
        } @else {
          <button (click)="createNewReport()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <i class="fas fa-plus mr-2"></i>
            <span>Start New Report</span>
          </button>
        }
      </div>
       <div class="flex-1"></div> <!-- Spacer -->
    </div>

    @if (statusMessage(); as msg) {
      <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-4 py-2 rounded-md shadow-lg text-center"
          [class.bg-green-100]="msg.type === 'success'"
          [class.text-green-800]="msg.type === 'success'"
          [class.bg-red-100]="msg.type === 'error'"
          [class.text-red-800]="msg.type === 'error'">
          <p class="text-sm font-medium">{{ msg.text }}</p>
      </div>
    }
  </div>
</div>